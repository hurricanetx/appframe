!function(t){"use strict";t.fn.dataloader=function(e,a){function n(e,a){var n;return n=a._$container==s?("innerHeight"in f?f.innerHeight:s.height())+s.scrollTop():a._$container.offset().top+t(a.container).height(),n<=e.offset().top-a.threshold}function i(e,a){var n;return n=a._$container==s?s.width()+(t.fn.scrollLeft?s.scrollLeft():f.pageXOffset):a._$container.offset().left+t(a.container).width(),n<=e.offset().left-a.threshold}function o(t,e){var a;return a=e._$container==s?s.scrollTop():e._$container.offset().top,a>=t.offset().top+e.threshold+t.height()}function r(e,a){var n;return n=a._$container==s?t.fn.scrollLeft?s.scrollLeft():f.pageXOffset:a._$container.offset().left,n>=e.offset().left+a.threshold+e.width()}function l(t,e){var a=0;t.each(function(l){function d(){f.trigger("_dataloader_appear"),a=0}var f=t.eq(l);if(!e.skip_invisible||f.width()||f.height()||"none"===f.css("display"))if(e.vertical_only)if(o(f,e));else if(n(f,e)){if(++a>e.failure_limit)return!1}else d();else if(o(f,e)||r(f,e));else if(n(f,e)||i(f,e)){if(++a>e.failure_limit)return!1}else d()})}var d,f=window,s=t(f),_=this,e=t.extend({},{threshold:0,container:f,failure_limit:0,vertical_only:!0,skip_invisible:!0,hasMinimumInterval:0,event:"scroll"},e),c=/(?:iphone|ipod|ipad).*os/gi.test(navigator.appVersion),p=c&&/(?:iphone|ipod|ipad).*os 5/gi.test(navigator.appVersion),u=function(e){var n=e._href+e._param;e._dataloader_loadStarted||(e._defaultText=e.html(),e.addClass("ui-loading-wrap").html('<p>加载中</p><i class="ui-loading"></i>'),e._dataloader_loadStarted=!0,t.get(n,function(n){return n=t.parseJSON(n),-1==n.code?(e.removeClass("ui-loading-wrap").html(n.message),e._dataloader_loadStarted=!0,e.off("_dataloader_appear"),void 0):(e.before(t.tpl(t("#"+e._tpl).html(),n)),a&&a(),e._method?e.data("param",e._method(e._param)):e.data("param",e._param++),e.removeClass("ui-loading-wrap").html(e._defaultText),e._dataloader_loadStarted=!1,void 0)}))};d=e._$container=e.container&&e.container!=f?t(e.container):s,delete e.container;var h="scroll"==e.event,m=h||"scrollstart"==e.event||"scrollstop"==e.event;if(m){var v=0!=e.minimum_interval,g=null;d.on(e.event,function(){return!h||!v||c&&!e.use_minimum_interval_in_ios?l(_,e):(g||(g=setTimeout(function(){l(_,e),g=null},e.minimum_interval)),void 0)})}return _.each(function(t){var a=_.eq(t);1!=a._dataloader_loadStarted&&(a._dataloader_loadStarted=!1),a._href=a.data("href"),a._param=a.data("param"),a._method=a.data("method"),a._tpl=a.data("tpl"),a._load=u,a.on("_dataloader_appear",function(){a._load(a)}),m||a.on(e.event,function(){a._dataloader_loadStarted||a.trigger("_dataloader_appear")})}),s.on("resize load",function(){l(_,e)}),this.tap(function(){l(_,e)}),p&&s.on("pageshow",function(t){t.originalEvent&&t.originalEvent.persisted&&_.trigger("_dataloader_appear")}),this}}(window.Zepto);